---
title: Knightmark
description: Stress test with 100+ animated knights, spatial hash collision detection, and state machines.
---

import { Tabs, TabItem } from '@astrojs/starlight/components';
import ExamplePreview from '../../../components/ExamplePreview';
import StackBlitzEmbed from '../../../components/StackBlitzEmbed';
import ExampleTabs from '../../../components/ExampleTabs.astro';
import { loadExample } from '../../../utils/loadExample';

export const vanillaFiles = loadExample('vanilla', 'knightmark');

<ExampleTabs>
<Tabs>
  <TabItem label="Preview" icon="rocket">
    <ExamplePreview client:load type="vanilla" name="knightmark" />
  </TabItem>
  <TabItem label="Three.js" icon="seti:javascript">
    <StackBlitzEmbed
      client:load
      title="Knightmark - Three.js"
      files={vanillaFiles}
      openFile="main.ts"
      height={600}
    />
  </TabItem>
</Tabs>
</ExampleTabs>

## Overview

Knightmark is a stress test that spawns 100+ animated knights using `AnimatedSprite2D` and `Flatland`. Each knight has a simple state machine (walk, roll, trip) and collisions are detected via a spatial hash grid.

Press **Space** or click the button to spawn 100 more knights.

## Knight State Machine

Each knight cycles through three states:

- **WALK** -- Moving at its base speed. Plays `idle` (slow) or `run` (fast) animation based on speed.
- **ROLL** -- One-shot `roll` animation triggered by a collision dodge. Knight keeps moving.
- **TRIP** -- One-shot `death` animation used as a stumble. Velocity lerps to zero, then briefly idles before resuming walk.

## Spatial Hash Collision

A spatial hash grid with 32px cells enables efficient broad-phase collision detection:

```typescript
class SpatialHash {
  private cells = new Map<number, Knight[]>()

  clear(): void { this.cells.clear() }

  insert(knight: Knight): void {
    const cx = Math.floor(knight.sprite.position.x / this.cellSize)
    const cy = Math.floor(knight.sprite.position.y / this.cellSize)
    // ...
  }

  query(knight: Knight): Knight[] {
    // Check 3x3 neighborhood around the knight's cell
    // ...
  }
}
```

## Y-Sorting

Knights are depth-sorted so lower sprites render in front:

```typescript
knight.zIndex = -Math.floor(knight.position.y)
```

## Next Steps

- [Animation](/examples/animation) -- AnimatedSprite2D basics
- [Batch Rendering](/examples/batch-demo) -- How automatic batching works
