---
title: Batch Rendering
description: How automatic batching works and tips for optimal performance.
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

SpriteGroup automatically batches sprites that share the same material into single draw calls. You don't need to do anything specialâ€”just add sprites and the batching happens behind the scenes.

## How It Works

When you add sprites to a `SpriteGroup`, they're grouped by material:

<Tabs syncKey="framework">
  <TabItem label="Three.js" icon="seti:javascript">
    ```typescript
    import { Sprite2D, SpriteGroup, Sprite2DMaterial } from '@three-flatland/core';

    const spriteGroup = new SpriteGroup();
    scene.add(spriteGroup);

    // These sprites share a material, so they batch together
    const material = new Sprite2DMaterial({ map: spriteSheet });

    for (let i = 0; i < 1000; i++) {
      const sprite = new Sprite2D({ material });
      sprite.position.set(Math.random() * 100, Math.random() * 100, 0);
      spriteGroup.add(sprite);
    }

    // In your render loop
    function animate() {
      spriteGroup.update();  // Rebuilds batches and uploads to GPU
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    ```
  </TabItem>
  <TabItem label="React" icon="seti:react">
    ```tsx
    import { useRef, useMemo } from 'react';
    import { extend, useFrame } from '@react-three/fiber/webgpu';
    import { Sprite2D, SpriteGroup, Sprite2DMaterial } from '@three-flatland/react';

    extend({ Sprite2D, SpriteGroup, Sprite2DMaterial });

    function Particles({ count = 1000, spriteSheet }) {
      const groupRef = useRef<SpriteGroup>(null);

      // Create shared material
      const material = useMemo(() => new Sprite2DMaterial({ map: spriteSheet }), [spriteSheet]);

      // Generate random positions once
      const positions = useMemo(
        () => Array.from({ length: count }, () => [Math.random() * 100, Math.random() * 100, 0]),
        [count]
      );

      useFrame(() => {
        groupRef.current?.update();
      });

      return (
        <spriteGroup ref={groupRef}>
          {positions.map((pos, i) => (
            <sprite2D key={i} material={material} position={pos} />
          ))}
        </spriteGroup>
      );
    }
    ```
  </TabItem>
</Tabs>

## Setup

Create a `SpriteGroup` and add it to your scene:

```typescript
const spriteGroup = new SpriteGroup();
scene.add(spriteGroup);
```

## Performance Monitoring

Check batch efficiency with the `stats` property:

```typescript
const stats = spriteGroup.stats;

console.log(`Sprites: ${stats.spriteCount}`);
console.log(`Batches: ${stats.batchCount}`);
console.log(`Draw calls: ${stats.drawCalls}`);
console.log(`Visible: ${stats.visibleSprites}`);
```

**Goal:** Keep `batchCount` low relative to `spriteCount`. If you have 1000 sprites but 100 batches, you're not batching efficiently.

## Optimization Tips

### Share Materials

Sprites only batch together when they share the **same material instance**:

```typescript
// Good: One material, one batch
const material = new Sprite2DMaterial({ map: atlas });
sprites.forEach(s => s.material = material);

// Bad: Many materials, many batches
sprites.forEach(s => {
  s.material = new Sprite2DMaterial({ map: atlas }); // Creates new batch each time!
});
```

### Use Texture Atlases

Combine textures into a single atlas. All sprites using the atlas can share one material:

```typescript
// Load a sprite sheet with frame data
const sheet = await SpriteSheetLoader.load('/sprites/atlas.json');

const material = new Sprite2DMaterial({ map: sheet.texture });

// Different frames, same material = same batch
const player = new Sprite2D({ material, frame: sheet.getFrame('player') });
const enemy = new Sprite2D({ material, frame: sheet.getFrame('enemy') });
```

### Organize by Layer

Sprites are sorted by layer before batching. Keep related sprites on the same layer:

```typescript
import { Layers } from '@three-flatland/core';

// Background sprites batch together
backgrounds.forEach(s => s.layer = Layers.BACKGROUND);

// Entity sprites batch together
entities.forEach(s => s.layer = Layers.ENTITIES);
```

### Invalidate Efficiently

When sprites change, mark them for update:

```typescript
// Single sprite changed
sprite.position.x += 10;
spriteGroup.invalidate(sprite);

// Many sprites changed
spriteGroup.invalidateAll();
```
