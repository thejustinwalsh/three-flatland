---
title: Batch Rendering
description: How automatic batching works and tips for optimal performance.
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

Renderer2D automatically batches sprites that share the same material into single draw calls. You don't need to do anything specialâ€”just add sprites and the batching happens behind the scenes.

## How It Works

When you add sprites to a `Renderer2D`, they're grouped by material:

<Tabs syncKey="framework">
  <TabItem label="Three.js" icon="seti:javascript">
    ```typescript
    import { Sprite2D, Renderer2D, Sprite2DMaterial } from '@three-flatland/core';

    const renderer2D = new Renderer2D();
    scene.add(renderer2D);

    // These sprites share a material, so they batch together
    const material = new Sprite2DMaterial({ map: spriteSheet });

    for (let i = 0; i < 1000; i++) {
      const sprite = new Sprite2D({ material });
      sprite.position.set(Math.random() * 100, Math.random() * 100, 0);
      renderer2D.add(sprite);
    }

    // In your render loop
    function animate() {
      renderer2D.update();  // Rebuilds batches and uploads to GPU
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    ```
  </TabItem>
  <TabItem label="React" icon="seti:react">
    ```tsx
    import { useRef } from 'react';
    import { useFrame } from '@react-three/fiber/webgpu';
    import { Sprite2D, Renderer2D, Sprite2DMaterial } from '@three-flatland/react';

    function Particles({ count = 1000 }) {
      const rendererRef = useRef<Renderer2D>(null);
      const materialRef = useRef<Sprite2DMaterial>(null);

      useFrame(() => {
        rendererRef.current?.update();
      });

      return (
        <renderer2D ref={rendererRef}>
          <sprite2DMaterial ref={materialRef} map={spriteSheet} />
          {Array.from({ length: count }, (_, i) => (
            <sprite2D
              key={i}
              material={materialRef.current!}
              position={[Math.random() * 100, Math.random() * 100, 0]}
            />
          ))}
        </renderer2D>
      );
    }
    ```
  </TabItem>
</Tabs>

## Renderer Options

The `Renderer2D` constructor accepts optional batch configuration:

```typescript
const renderer2D = new Renderer2D();
scene.add(renderer2D);
```

## Performance Monitoring

Check batch efficiency with the `stats` property:

```typescript
const stats = renderer2D.stats;

console.log(`Sprites: ${stats.spriteCount}`);
console.log(`Batches: ${stats.batchCount}`);
console.log(`Draw calls: ${stats.drawCalls}`);
console.log(`Visible: ${stats.visibleSprites}`);
```

**Goal:** Keep `batchCount` low relative to `spriteCount`. If you have 1000 sprites but 100 batches, you're not batching efficiently.

## Optimization Tips

### Share Materials

Sprites only batch together when they share the **same material instance**:

```typescript
// Good: One material, one batch
const material = new Sprite2DMaterial({ map: atlas });
sprites.forEach(s => s.material = material);

// Bad: Many materials, many batches
sprites.forEach(s => {
  s.material = new Sprite2DMaterial({ map: atlas }); // Creates new batch each time!
});
```

### Use Texture Atlases

Combine textures into a single atlas. All sprites using the atlas can share one material:

```typescript
// Load a sprite sheet with frame data
const { texture, frames } = await SpriteSheetLoader.load('/sprites/atlas.json');

const material = new Sprite2DMaterial({ map: texture });

// Different frames, same material = same batch
const player = new Sprite2D({ material, frame: frames.get('player') });
const enemy = new Sprite2D({ material, frame: frames.get('enemy') });
```

### Organize by Layer

Sprites are sorted by layer before batching. Keep related sprites on the same layer:

```typescript
import { Layers } from '@three-flatland/core';

// Background sprites batch together
backgrounds.forEach(s => s.layer = Layers.BACKGROUND);

// Entity sprites batch together
entities.forEach(s => s.layer = Layers.ENTITIES);
```

### Invalidate Efficiently

When sprites change, mark them for update:

```typescript
// Single sprite changed
sprite.position.x += 10;
renderer2D.invalidate(sprite);

// Many sprites changed
renderer2D.invalidateAll();
```
