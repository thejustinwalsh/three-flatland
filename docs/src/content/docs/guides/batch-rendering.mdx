---
title: Batch Rendering
description: Optimize performance when rendering thousands of sprites.
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

## Overview

Batch rendering combines multiple sprites into a single draw call, dramatically improving performance when rendering many sprites.

## Instanced Rendering

For sprites sharing the same texture, use instanced rendering:

<Tabs syncKey="framework">
  <TabItem label="Vanilla" icon="seti:javascript">
    ```typescript
    import { InstancedSprite2D, Renderer2D } from '@three-flatland/core';

    const instancedSprite = new InstancedSprite2D({
      texture: myTexture,
      count: 1000,  // Maximum instance count
    });

    renderer2D.add(instancedSprite);

    // Set individual instance transforms
    for (let i = 0; i < 1000; i++) {
      instancedSprite.setPositionAt(i, x, y);
      instancedSprite.setScaleAt(i, scaleX, scaleY);
      instancedSprite.setRotationAt(i, rotation);
    }

    instancedSprite.update();  // Apply changes
    ```
  </TabItem>
  <TabItem label="React" icon="seti:react">
    ```tsx
    function Particles() {
      const ref = useRef<InstancedSprite2D>(null);

      useFrame(() => {
        if (!ref.current) return;
        // Update instance transforms each frame
        for (let i = 0; i < 1000; i++) {
          ref.current.setPositionAt(i, positions[i].x, positions[i].y);
        }
        ref.current.update();
      });

      return (
        <renderer2D>
          <instancedSprite2D ref={ref} texture={texture} count={1000} />
        </renderer2D>
      );
    }
    ```
  </TabItem>
</Tabs>

## Performance Tips

### Use Texture Atlases

Combine multiple sprite textures into a single atlas to minimize texture bindings:

```typescript
const atlas = new TextureAtlas({
  textures: [sprite1, sprite2, sprite3],
  padding: 2,
});

const sprite = new Sprite2D({
  texture: atlas.texture,
  frame: atlas.getFrame('sprite1'),
});
```

### Instance Count

Set the instance count to your expected maximum. Growing the buffer dynamically is expensive.

```typescript
// Good: Set expected maximum upfront
const particles = new InstancedSprite2D({
  count: 10000,
});

// Then only render what you need
particles.visibleCount = activeParticleCount;
```

### Frustum Culling

Sprites outside the camera view are automatically culled. For large scenes, consider spatial partitioning:

```typescript
renderer2D.frustumCulled = true;  // Enabled by default
```

## Benchmarks

| Sprite Count | Regular Sprites | Instanced Sprites |
|-------------|-----------------|-------------------|
| 100 | 60 fps | 60 fps |
| 1,000 | 45 fps | 60 fps |
| 10,000 | 8 fps | 60 fps |
| 100,000 | < 1 fps | 55 fps |

*Tested on M1 MacBook Pro with WebGPU*
