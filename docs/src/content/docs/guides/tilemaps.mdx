---
title: Tilemaps
description: Render tile-based maps efficiently with three-flatland.
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

Tilemaps allow you to render large tile-based environments efficiently using chunked rendering. The `TileMap2D` class handles maps with multiple layers and automatic chunking for performance.

## Creating a Tilemap

<Tabs syncKey="framework">
  <TabItem label="Three.js" icon="seti:javascript">
    ```typescript
    import { TileMap2D, TiledLoader } from '@three-flatland/core';

    // Load a Tiled map
    const mapData = await TiledLoader.load('/maps/level1.json');

    // Create tilemap
    const tilemap = new TileMap2D({
      data: mapData,
      chunkSize: 16,  // Tiles per chunk (default: 16)
    });

    scene.add(tilemap);

    // In your animation loop
    function animate() {
      tilemap.update(deltaMs);  // Update animated tiles
      renderer.render(scene, camera);
    }
    ```
  </TabItem>
  <TabItem label="React" icon="seti:react">
    ```tsx
    import { TileMap2D, TiledLoader } from '@three-flatland/react';
    import { useRef, useEffect, useState } from 'react';
    import { useFrame } from '@react-three/fiber/webgpu';

    function Level() {
      const [mapData, setMapData] = useState(null);
      const tilemapRef = useRef<TileMap2D>(null);

      useEffect(() => {
        TiledLoader.load('/maps/level1.json').then(setMapData);
      }, []);

      useFrame((_, delta) => {
        tilemapRef.current?.update(delta * 1000);
      });

      if (!mapData) return null;

      return <tileMap2D ref={tilemapRef} data={mapData} chunkSize={16} />;
    }
    ```
  </TabItem>
</Tabs>

## Map Data Structure

The `TileMapData` interface describes the map format:

```typescript
interface TileMapData {
  width: number;           // Map width in tiles
  height: number;          // Map height in tiles
  tileWidth: number;       // Tile width in pixels
  tileHeight: number;      // Tile height in pixels
  orientation: 'orthogonal' | 'isometric' | 'staggered' | 'hexagonal';
  renderOrder: 'right-down' | 'right-up' | 'left-down' | 'left-up';
  infinite: boolean;       // Infinite map flag
  tilesets: TilesetData[];
  tileLayers: TileLayerData[];
  objectLayers: ObjectLayerData[];
  properties?: Record<string, unknown>;
}
```

## Loading Maps

### Tiled Editor (.json/.tmj)

Load maps created with the [Tiled Map Editor](https://www.mapeditor.org/):

```typescript
import { TiledLoader } from '@three-flatland/core';

const mapData = await TiledLoader.load('/maps/level1.json');
const tilemap = new TileMap2D({ data: mapData });
```

### LDtk Editor (.ldtk)

Load maps created with [LDtk](https://ldtk.io/):

```typescript
import { LDtkLoader } from '@three-flatland/core';

const project = await LDtkLoader.loadProject('/maps/world.ldtk');
const level = await LDtkLoader.loadLevel(project, 'Level_0');

const tilemap = new TileMap2D({ data: level.mapData });
```

## Working with Layers

Access and manipulate tile layers:

```typescript
// Get layer by index
const groundLayer = tilemap.getLayerAt(0);
const wallsLayer = tilemap.getLayerAt(1);

// Toggle visibility
groundLayer.visible = false;

// Get layer count
console.log(tilemap.layerCount);
```

## Tile Operations

Read and modify tiles at runtime:

```typescript
// Get layer
const layer = tilemap.getLayerAt(0);

// Read tile at position
const tileGid = layer.getTileAt(x, y);

// Set tile at position
layer.setTileAt(x, y, newTileGid);
```

## Coordinate Conversion

Convert between world and tile coordinates:

```typescript
// World position to tile position
const tilePos = tilemap.worldToTile(worldX, worldY);
console.log(tilePos.x, tilePos.y);

// Tile position to world position
const worldPos = tilemap.tileToWorld(tileX, tileY);
console.log(worldPos.x, worldPos.y);
```

## Statistics

Get information about the tilemap:

```typescript
console.log('Total tiles:', tilemap.totalTileCount);
console.log('Total chunks:', tilemap.totalChunkCount);
console.log('Layer count:', tilemap.layerCount);
```

## Chunked Rendering

Tilemaps use chunked rendering for performance. Configure the chunk size based on your needs:

```typescript
const tilemap = new TileMap2D({
  data: mapData,
  chunkSize: 16,  // 16x16 tiles per chunk (default)
});
```

Smaller chunks = more draw calls but finer culling. Larger chunks = fewer draw calls but coarser culling. The default of 16 works well for most cases.

## Animated Tiles

Tiles with animation data (from Tiled) are automatically animated. Call `update()` each frame:

```typescript
function animate() {
  const deltaMs = /* time since last frame */;
  tilemap.update(deltaMs);
  renderer.render(scene, camera);
}
```

## Disposing

Clean up resources when done:

```typescript
scene.remove(tilemap);
tilemap.dispose();
```
