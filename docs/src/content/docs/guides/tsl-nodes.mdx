---
title: TSL Nodes
description: Create custom shader effects using Three Shader Language.
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

TSL (Three Shader Language) is a node-based shader system in Three.js that enables custom GPU effects without writing raw WGSL/GLSL code.

three-flatland provides pre-built TSL nodes for common 2D sprite effects. All nodes are exported from `@three-flatland/core`.

## Using Built-in Nodes

<Tabs syncKey="framework">
  <TabItem label="Three.js" icon="seti:javascript">
    ```typescript
    import { MeshBasicNodeMaterial } from 'three/webgpu';
    import { texture as sampleTexture, uv, Fn } from 'three/tsl';
    import {
      SpriteSheetLoader,
      sampleSprite,
      spriteUV,
      tint,
      outline8,
      hueShift,
      dissolvePixelated,
    } from '@three-flatland/core';

    // Load spritesheet
    const spriteSheet = await SpriteSheetLoader.load('/sprites/character.json');

    // Create material with TSL nodes
    const material = new MeshBasicNodeMaterial();
    material.transparent = true;

    // Frame uniform for animation
    const frameUniform = uniform(new Vector4(0, 0, 0.125, 0.125));

    // Apply outline effect
    material.colorNode = Fn(() => {
      const frameUV = spriteUV(frameUniform);
      const color = sampleTexture(spriteSheet.texture, frameUV);
      return outline8(color, frameUV, spriteSheet.texture, {
        color: [1, 0, 0, 1],  // Red outline
        thickness: 0.003,
      });
    })();
    ```
  </TabItem>
  <TabItem label="React" icon="seti:react">
    ```tsx
    import { useMemo } from 'react';
    import { MeshBasicNodeMaterial } from 'three/webgpu';
    import { Fn } from 'three/tsl';
    import { sampleSprite, tint } from '@three-flatland/core';

    function TintedSprite({ texture, frameUniform }) {
      const material = useMemo(() => {
        const mat = new MeshBasicNodeMaterial();
        mat.transparent = true;
        mat.colorNode = Fn(() => {
          const color = sampleSprite(texture, frameUniform);
          return tint(color, [1.0, 0.5, 0.5]); // Pink tint
        })();
        return mat;
      }, [texture, frameUniform]);

      return <mesh material={material}>...</mesh>;
    }
    ```
  </TabItem>
</Tabs>

## Sprite Sampling Nodes

### `sampleSprite`

Sample a texture with frame coordinates and optional alpha test:

```typescript
import { sampleSprite } from '@three-flatland/core';

// Sample with alpha test (discard transparent pixels)
const color = sampleSprite(texture, frameUniform, { alphaTest: 0.01 });

// Sample without alpha test
const color = sampleSprite(texture, frameUniform);
```

### `spriteUV`

Convert frame uniform to UV coordinates:

```typescript
import { spriteUV } from '@three-flatland/core';

const frameUV = spriteUV(frameUniform);
// Use frameUV for texture sampling or effects
```

## Color Nodes

### `tint` / `tintAdditive`

Apply color tint to a sprite:

```typescript
import { tint, tintAdditive } from '@three-flatland/core';

// Multiplicative tint (darkens)
const tinted = tint(color, [1.0, 0.5, 0.5]); // Pink

// Additive tint with strength (damage flash)
const flashed = tintAdditive(color, [1, 1, 1], flashStrength);
```

### `hueShift`

Rotate hue (rainbow effect):

```typescript
import { hueShift } from '@three-flatland/core';

// Shift by radians (animate timeUniform for rainbow)
const shifted = hueShift(color, timeUniform.mul(3.0));
```

### `saturate` / `grayscale`

Adjust saturation:

```typescript
import { saturate, grayscale } from '@three-flatland/core';

// Full grayscale (petrified effect)
const gray = saturate(color, 0);

// Increase saturation
const vivid = saturate(color, 1.5);

// Direct grayscale conversion
const gray = grayscale(color);
```

### `brightness` / `contrast`

Adjust brightness and contrast:

```typescript
import { brightness, contrast } from '@three-flatland/core';

// Brighten
const bright = brightness(color, 0.2);

// Increase contrast
const contrasty = contrast(color, 1.5);
```

## Effect Nodes

### `outline8`

Add outline around sprite (8-direction sampling):

```typescript
import { outline8 } from '@three-flatland/core';

const outlined = outline8(color, uv, texture, {
  color: [0.3, 1, 0.3, 1],  // Green outline
  thickness: 0.003,          // Outline width
});
```

### `pixelate`

Apply pixelation effect:

```typescript
import { pixelate, pixelateBySize } from '@three-flatland/core';

// By pixel count
const pixelatedUV = pixelate(uv, vec2(32, 32));

// By pixel size
const pixelatedUV = pixelateBySize(uv, vec2(0.03125));
```

### `dissolve`

Dissolve effect with noise texture:

```typescript
import { dissolve, dissolvePixelated, dissolveDirectional } from '@three-flatland/core';

// Basic dissolve
const dissolved = dissolve(color, uv, progress, noiseTexture);

// Pixelated dissolve (retro style)
const dissolved = dissolvePixelated(color, uv, progress, noiseTexture, 16);

// Directional dissolve
const dissolved = dissolveDirectional(color, uv, progress, direction);
```

## Retro Effect Nodes

### `colorReplace`

Replace one color with another:

```typescript
import { colorReplace, colorReplaceHard, colorReplaceMultiple } from '@three-flatland/core';

// Soft replacement with tolerance
const replaced = colorReplace(color, oldColor, newColor, 0.1);

// Hard replacement (exact match)
const replaced = colorReplaceHard(color, oldColor, newColor);

// Replace multiple colors
const replaced = colorReplaceMultiple(color, colorPairs, 0.1);
```

### `bayerDither`

Ordered dithering (retro style):

```typescript
import { bayerDither2x2, bayerDither4x4, bayerDither8x8 } from '@three-flatland/core';

// 2x2 matrix dithering
const dithered = bayerDither2x2(color, levels, scale);

// 4x4 matrix (default)
const dithered = bayerDither4x4(color, levels, scale);

// 8x8 matrix (finest)
const dithered = bayerDither8x8(color, levels, scale);
```

### `palettize`

Map colors to a palette:

```typescript
import { palettize, palettizeDithered, palettizeNearest } from '@three-flatland/core';

// With dithering (smooth gradients)
const paletted = palettizeDithered(color, paletteTexture);

// Nearest color (hard edges)
const paletted = palettizeNearest(color, paletteTexture);
```

### `posterize`

Reduce color levels:

```typescript
import { posterize } from '@three-flatland/core';

// Reduce to 4 levels per channel
const posterized = posterize(color, 4);
```

## Combining Effects

Chain multiple effects together:

```typescript
import { Fn } from 'three/tsl';
import { sampleSprite, tint, outline8, hueShift } from '@three-flatland/core';

material.colorNode = Fn(() => {
  // Sample sprite
  const color = sampleSprite(texture, frameUniform, { alphaTest: 0.01 });

  // Apply hue shift
  const shifted = hueShift(color, timeUniform);

  // Add outline
  const frameUV = spriteUV(frameUniform);
  const outlined = outline8(shifted, frameUV, texture, {
    color: [1, 1, 0, 1],
    thickness: 0.002,
  });

  return outlined;
})();
```

## Display Effect Nodes

For full-screen post-processing effects, see the [Post-Processing Guide](/guides/post-processing). Here's a quick reference of available display nodes:

### CRT Effects

```typescript
import {
  crtComplete,        // All-in-one CRT effect
  crtCurvature,       // Screen curvature
  crtVignette,        // Edge darkening
  crtBloom,           // Phosphor glow
  scanlines,          // Horizontal scan lines
  phosphorMask,       // RGB subpixel pattern
} from '@three-flatland/core';
```

### LCD Effects

```typescript
import {
  lcdGrid,            // Pixel grid overlay
  lcdGBC,             // Game Boy Color LCD
  dotMatrix,          // Dot matrix display
} from '@three-flatland/core';
```

### Console Palettes

```typescript
import {
  dmgPalette,         // Game Boy (4 greens)
  gbcPalette,         // Game Boy Color
  snesPalette,        // SNES (15-bit)
  cgaPalette,         // CGA (4 colors)
  c64Palette,         // Commodore 64
} from '@three-flatland/core';
```

### Analog Video Effects

```typescript
import {
  vhsDistortion,      // VHS tracking distortion
  staticNoise,        // TV static
  chromaticAberration, // RGB channel separation
  filmGrain,          // Film noise
  vignette,           // Edge darkening
} from '@three-flatland/core';
```

## Lighting Nodes

For dynamic sprite lighting, see the [2D Lighting Guide](/guides/lighting). Here's a quick reference:

### Light Calculations

```typescript
import {
  pointLight2D,       // Point/radial light
  spotLight2D,        // Cone light
  directionalLight2D, // Parallel rays (sun)
  ambientLight2D,     // Uniform illumination
} from '@three-flatland/core';

// Returns { direction, color, attenuation }
const light = pointLight2D(surfacePos, lightPos, lightColor, intensity, radius);
```

### Lighting Functions

```typescript
import {
  litDiffuse,         // Lambertian shading
  litSpecular,        // Specular highlights
  litRim,             // Fresnel edge glow
  litCelShaded,       // Toon shading
  litSprite,          // Combined sprite lighting
} from '@three-flatland/core';
```

### Normal Generation

```typescript
import {
  normalFromSprite,   // Normals from alpha edges
  normalFromSpriteRounded, // Convex appearance
  normalFromHeight,   // From height map
} from '@three-flatland/core';
```

### Shadows

```typescript
import {
  shadowDrop,         // Hard drop shadow
  shadowDropSoft,     // Blurred drop shadow
  shadow2D,           // Ray-traced shadow
  shadowSoft2D,       // Soft ray-traced shadow
} from '@three-flatland/core';
```

## Performance Tips

- Complex node graphs increase shader compile time
- Use `uniform()` for values that change frequently
- Cache compiled materials when reusing effects
- Avoid dynamic branching in hot paths
- Post-processing effects add GPU overhead - use sparingly on mobile
- Limit dynamic lights to 2-4 per scene for best performance
